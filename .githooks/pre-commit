#!/bin/bash
# Pre-commit hook for Scrybe
# Runs the same checks as CI/CD pipeline

set -e

echo "ü¶â Scrybe Pre-Commit Checks"
echo "============================"
echo ""

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Source cargo environment if needed
if [ -f "$HOME/.cargo/env" ]; then
    source "$HOME/.cargo/env"
fi

# Check if cargo is available
if ! command -v cargo &> /dev/null; then
    echo -e "${RED}‚úó cargo not found. Please install Rust.${NC}"
    exit 1
fi

# 1. Format Check
echo "1Ô∏è‚É£  Running rustfmt..."
if cargo fmt --all -- --check; then
    echo -e "${GREEN}‚úì Code formatting check passed${NC}"
else
    echo -e "${RED}‚úó Code formatting check failed${NC}"
    echo -e "${YELLOW}Run 'cargo fmt --all' to fix formatting${NC}"
    exit 1
fi
echo ""

# 2. Clippy
echo "2Ô∏è‚É£  Running clippy..."
if cargo clippy --workspace --all-features -- -D warnings; then
    echo -e "${GREEN}‚úì Clippy passed (zero warnings)${NC}"
else
    echo -e "${RED}‚úó Clippy found issues${NC}"
    echo -e "${YELLOW}Fix clippy warnings before committing${NC}"
    exit 1
fi
echo ""

# 3. Tests
echo "3Ô∏è‚É£  Running tests..."
if cargo test --workspace --all-features; then
    echo -e "${GREEN}‚úì All tests passed${NC}"
else
    echo -e "${RED}‚úó Tests failed${NC}"
    exit 1
fi
echo ""

# 4. Security Audit
echo "4Ô∏è‚É£  Running security audit..."

# Check if cargo-audit is installed
if ! command -v cargo-audit &> /dev/null; then
    echo -e "${YELLOW}‚ö† cargo-audit not installed. Installing...${NC}"
    cargo install cargo-audit
fi

if cargo audit; then
    echo -e "${GREEN}‚úì Security audit passed${NC}"
else
    echo -e "${YELLOW}‚ö† Security audit found issues${NC}"
    echo -e "${YELLOW}Review the issues above. Use 'git commit --no-verify' to bypass if needed.${NC}"
    exit 1
fi
echo ""

# 5. Build Check
echo "5Ô∏è‚É£  Running build check..."
if cargo build --workspace --all-features; then
    echo -e "${GREEN}‚úì Build succeeded${NC}"
else
    echo -e "${RED}‚úó Build failed${NC}"
    exit 1
fi
echo ""

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}üéâ All pre-commit checks passed!${NC}"
echo -e "${GREEN}========================================${NC}"

exit 0
